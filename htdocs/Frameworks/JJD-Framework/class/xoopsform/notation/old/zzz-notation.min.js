function notation_onMouseMove(aa){notation=notation_getNotationEvent(aa,"notation_onMouseMove");if(!notation)return false;notation.onMouseMove(aa);}
function notation_onMouseOut(ba){notation=notation_getNotationEvent(ba,"notation_onMouseOut");if(!notation)return false;notation.onMouseOut(ba);}
function notation_onMouseDown(ca){notation=notation_getNotationEvent(ca,"notation_onMouseDown");if(!notation)return false;notation.onClick(ca);}
function notation_getNotationEvent(da,ea){var fa=da.target||da.srcElement;id=fa.getAttribute('clName');if(!id)return false;notation=notation_getNotation(id);return notation;}
function notation_getNotation(id){var ga=id.replace('[','_');ga=ga.replace(']','_');notation=eval(ga);notation.init();return notation;}
var clsNotation=function(ha){if(typeof clsNotation.initialized=="undefined"){clsNotation.prototype.exist=function(){return true;}
clsNotation.prototype.init=function(){this.getObjects();}
clsNotation.prototype.debug=function(ia){if(!this.ob.debug){this.ob.debug=document.createElement("div");this.ob.debug.id='debug';this.ob.debug.className='notation_debug';document.body.appendChild(this.ob.debug);}
this.ob.debug.innerHTML=this.clName+"<br>"+ia;}
clsNotation.prototype.getObjects=function(){keys=new Array('component','img0','img1','img2','bulle','libAverage','masque');this.ob=new Array();this.ob.note=document.getElementById(this.jsap.name);for(h=0;h<keys.length;h++){id=this.jsap.name+'['+keys[h]+']';this.ob[keys[h]]=document.getElementById(id);}
if(this.ob.masque){this.ob.masque.style.left='0px';this.ob.masque.style.top='0px';}
return true;}
clsNotation.prototype.showBulle=function(ja,x,y){if(this.jsap.showBulle==0)return false;this.debug(x+'-'+y+' : '+ja);if(!this.ob.bulle){idBulle=this.jsap.name+"[bulle]";this.ob.bulle=document.createElement("div");this.ob.bulle.id=idBulle;this.ob.bulle.className='notation_bulle';this.ob.bulle.style.padding='5px';this.ob.bulle.style.backgroundColor='#'+this.jsap.background;this.ob.bulle.style.top=(y)+'px';ja+=" | new";document.body.appendChild(this.ob.bulle);}
this.ob.bulle.style.left=x+'px';this.ob.bulle.innerHTML=ja;}
clsNotation.prototype.getPosBulle=function(ka){t=this.findPos(this.ob.component);if(this.jsap.showBulle!=1)t.x=ka.clientX+this.jsap.showBulle*1;t.y+=this.jsap.height*1+4;return t;}
clsNotation.prototype.onMouseOut=function(la){this.getObjects();if(this.ob.bulle){this.ob.bulle.parentNode.removeChild(this.ob.bulle);this.ob.bulle=null;}
if(this.jsap.outMode=='r')return true;if(this.ob.note.value!=this.jsap.newNote){this.jsap.newNote=this.ob.note.value;this.adjust(0);}
return true;}
clsNotation.prototype.onClick=function(ma){this.getObjects();newNote=this.jsap.newNote;alert("nouvelle note : "+this.jsap.newNote);this.setNewNote(newNote,1);}
clsNotation.prototype.onMouseMove=function(na){this.getObjects();switch(this.jsap.outMode){case 'w':this.onMouseMove_write(na);break;default:this.onMouseMove_read(na);break;}}
clsNotation.prototype.onMouseMove_read=function(oa){}
clsNotation.prototype.onMouseMove_write=function(pa){newNote=(pa.clientX-this.getLeft(this.ob.component))/(this.jsap.fullWidth)*this.jsap.noteMax;if(newNote>this.jsap.noteMax)newNote=this.jsap.noteMax*1;if(newNote<this.jsap.noteMin)newNote=this.jsap.noteMin*1;switch(this.jsap.round){case -1:break;newNote=Math.floor(newNote)*1;case -2:newNote=Math.ceil(newNote)*1;break;default:newNote=newNote.toFixed(this.jsap.round)*1;break;}
this.jsap.newNote=newNote;newAverage=(this.jsap.sum*1+this.jsap.newNote*1)/(this.jsap.count*1+1);this.jsap.newAverage=newAverage.toFixed(1);t=this.getPosBulle(pa);var qa=this.jsap._NOT_VALIDATE_NEW_NOTE+this.jsap.newNote;this.showBulle(qa,t.x,t.y);this.adjust(1);}
clsNotation.prototype.adjust=function(ra){if(ra==1){v=this.jsap.newNote;if(v<this.jsap.noteMin)v=this.jsap.noteMin;if(v>this.jsap.noteMax)v=this.jsap.noteMax;average=this.jsap.newAverage*1;}else{v=this.jsap.average;if(v<this.jsap.noteMin)v=this.jsap.noteMin;if(v>this.jsap.noteMax)v=this.jsap.noteMax;average=this.jsap.average*1;}
vInt=Math.floor(v);vDec=v-vInt;imgWidth=this.jsap.imgWidth;img1WidthInt=(vInt-this.jsap.noteMin)*this.jsap.imgWidth;img1WidthDec=Math.floor((imgWidth*vDec))*1;img1Width=img1WidthInt+img1WidthDec;img2Width=this.jsap.width-img1Width;grisLeft=-img1WidthDec;this.ob.img1.style.width=img1Width+'px';this.ob.img2.style.width=img2Width+'px';this.ob.img2.style.backgroundPosition=grisLeft+'px 0px';if(this.ob.libAverage){if(this.jsap.showAverage==1){libelle="&nbsp;"+average.toFixed(1);}else{libelle="&nbsp;"+average+' / '+this.jsap.noteMax;}
this.ob.libAverage.innerHTML="&nbsp;"+libelle;}}
clsNotation.prototype.getLeft=function(sa){if(sa.offsetParent)return(sa.offsetLeft+this.getLeft(sa.offsetParent));else return(sa.offsetLeft);}
clsNotation.prototype.getTop=function(ta){if(ta.offsetParent)return(ta.offsetTop+this.getTop(ta.offsetParent));else return(ta.offsetTop);}
clsNotation.prototype.findPos=function(ua){var x=y=0;if(ua.offsetParent){do{x+=ua.offsetLeft;y+=ua.offsetTop;}
while(ua=ua.offsetParent);t=new Array();t.x=x;t.y=y;return t;}}
clsNotation.prototype.setNewNote=function(va,op){this.getObjects();if(this.jsap.url=='')return false;url=this.jsap.url;tParams=new Array();if(url.indexOf("values",0)>0){url+='|'+this.jsap.name+'|'+op+'|'+va;tParams={};}else{tParams={'jsRootId':this.jsap.name,'op':op,'note':va};}$.getJSON(url,tParams,function(r){id=r['jsRootId'];var wa=id.replace('[','_');wa=wa.replace(']','_');notation=eval(wa);notation.jsap.note=r['noteAverage'];notation.jsap.average=r['noteAverage'];notation.jsap.newAverage=r['noteAverage'];notation.jsap.sum=r['noteSum'];notation.jsap.count=r['noteCount'];notation.adjust(0);if(r.op==1){message=notation.jsap._NOT_NEW_AVERAGE.replace("%newAverage%",r['noteAverage']);message=message.replace("%newNote%",r['newNote']);alert(message);}});return false;}
clsNotation.initialized=true;}
this.jsap=ha;if(ha.clName){this.clName=ha.clName;}else{this.clName=name.replace('[','_');this.clName=this.clName.replace(']','_');}
this.value=ha.value;this.debugCompteur=0;this.ob=new Array();this.getObjects();this.ok=false;}